
fork函数的返回值实现，核心是**操作系统在创建子进程的过程中，通过区分父/子进程上下文，主动设置不同返回值**，本质是内核层对进程控制块（PCB）的差异化处理，具体逻辑可拆解为3步：

1. **内核创建子进程：复制与初始化**  
   当父进程调用fork时，内核会先为子进程分配新的PCB（记录进程ID、状态等核心信息），并复制父进程的内存空间（代码段、数据段等，现代系统多用“写时复制”优化，避免立即拷贝）。此时父、子进程的代码逻辑完全相同，且都停留在fork函数的内核执行阶段。

2. **区分进程身份：标记父/子上下文**  
   内核会明确标记两个进程的身份：原进程为“父进程”，新创建的为“子进程”。关键是，内核会为两者设置不同的“返回值标记”——对父进程，标记为“返回子进程的PID”；对子进程，标记为“返回0”。

3. **进程恢复执行：返回值的传递**  
   内核完成子进程创建后，会分别将父、子进程从内核态切换回用户态，继续执行fork函数后续的代码。此时，内核会根据之前的“返回值标记”，将对应的数值（父进程获子PID，子进程获0）作为fork函数的返回值，传递给用户态代码。

简单说：**不是fork“返回两次”，而是内核创建了两个独立进程，且为每个进程“定制”了不同的返回值**——父进程需通过子PID管理子进程，故返回PID；子进程可通过返回0确认自身身份，若需父PID则需调用getppid()。